server {
  listen {{nginx_port|default(1080)}};
  server_name {{domain|default(ansible_hostname)}};
  root {{root}};

  {% block proxy_setup %}
  set_real_ip_from 127.0.0.1;
  real_ip_header X-Forwarded-For;
  {% endblock %}

  client_max_body_size 200m;

  access_log syslog:server=unix:/var/run/nginx-log.sock combined_with_reqid;
  error_log syslog:server=unix:/var/run/nginx-log.sock notice;

  {% block cors %}
  add_header Access-Control-Allow-Origin '*';
  add_header Access-Control-Allow-Methods  'GET,POST,PUT,DELETE,OPTIONS';
  add_header Access-Control-Allow-Headers 'Keep-Alive,User-Agent,If-Modified-Since,Cache-Control,X-Requested-With,Content-Type,Origin,Authorization';
  {% endblock %}

  location ~* ^/({% block symfony_path_pattern %}api|apidoc|openid|_profiler{% endblock %})(/|$) {
    {% block cors_options %}
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Max-Age 3600;
      add_header Content-Type 'text/plain charset=UTF-8';
      add_header Content-Length 0;
      return 204;
    }
    {% endblock %}

    port_in_redirect off;
    {% if symfony_devmode|default(false) %}
      {% set phpscript = 'app' %}
    {% else %}
      {% set phpscript = 'app_dev' %}
    {% endif %}
    rewrite ^ {{root}}{{phpscript}}.php?$query_string break;

    include fastcgi_params;
    fastcgi_pass unix:/var/run/php5-fpm-{{name}}.sock;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

    {% block fastcgi_https_proxy %}
    fastcgi_param SERVER_PORT 443;
    fastcgi_param HTTPS ON;
    {% endblock %}
  }

  location /bundles {
    alias {{root}}/bundles/;
  }

  {% block extra_locations %}{% endblock %}
}
